<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תפוס מקום!</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#2563eb" />
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }
    </script>
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
          
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet Map JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
            
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Base styling */
        html, body {
            height: 100%;
        }

        :root {
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            font-family: 'Rubik', 'Inter', sans-serif;
            overscroll-behavior: none; /* Prevents pull-to-refresh */
            min-height: 100vh;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }

        @supports (height: 100dvh) {
            body {
                min-height: 100dvh;
            }
        }

        #main-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
        }

        @supports (height: 100dvh) {
            #main-screen {
                min-height: 100dvh;
            }
        }
        
        /* Custom User Icon for Leaflet */
        .user-location-icon {
            width: 18px !important;
            height: 18px !important;
            background-color: #ef4444; /* red-500 */
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            transform: translate(-9px, -9px); /* Center the icon */
        }

        /* Map fixes */
        .leaflet-container {
            z-index: 10;
        }

        /* Loading Spinner */
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Slide Transitions */
        .slide {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .slide.hidden {
            opacity: 0;
            transform: translateX(100%);
            position: absolute;
        }
        .slide.active {
            opacity: 1;
            transform: translateX(0);
            position: relative;
        }
        
        /* Tab Styles */
        .tab-btn {
            transition: all 0.2s ease-in-out;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Floating Card Animation */
        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .float-in {
            animation: floatIn 0.5s ease-out forwards;
        }

        /* Timer pulse */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .timer-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .safe-bottom-space {
            padding-bottom: calc(1.5rem + var(--safe-area-bottom));
        }

        .safe-bottom-pad {
            padding-bottom: var(--safe-area-bottom);
        }

        .bottom-safe {
            bottom: calc(1rem + var(--safe-area-bottom));
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col overflow-x-hidden">

    <!-- Onboarding Modal -->
    <div id="onboarding-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-start sm:items-center justify-center z-50 p-4 overflow-y-auto" style="padding-top: calc(1rem + var(--safe-area-top)); padding-bottom: calc(1rem + var(--safe-area-bottom));">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 relative overflow-y-auto">
                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                    <div id="onboarding-progress" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 33%"></div>
                </div>

                <!-- Slide Container -->
                <div class="relative min-h-[16rem]">
                    <!-- Slide 1 -->
                    <div id="slide-1" class="slide active">
                        <h2 class="text-2xl font-bold mb-4">ברוכים הבאים ל-תפוס מקום!</h2>
                        <p class="text-gray-700 mb-6">רוצים לדעת כמה זמן תחכו בתור? האפליקציה הזו עוזרת לכם ולשאר המשתמשים לדעת בדיוק את זה.</p>
                        <ul class="list-disc list-inside text-gray-700 space-y-2 mb-6">
                            <li><strong class="text-blue-600">חפשו</strong> מקום</li>
                            <li><strong class="text-blue-600">התחילו</strong> טיימר (צ'ק-אין)</li>
                            <li><strong class="text-blue-600">הגיעו</strong> ליעד!</li>
                        </ul>
                        <button onclick="nextSlide(2)" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition">הבא</button>
                    </div>
                    <!-- Slide 2 -->
                    <div id="slide-2" class="slide hidden">
                        <h2 class="text-2xl font-bold mb-4">איך זה עובד: צעד 1+2</h2>
                        <p class="text-gray-700 mb-6">חפשו מקום או בחרו אותו מהמפה.</p>
                        <ul class="list-disc list-inside text-gray-700 space-y-2 mb-6">
                            <li>לחצו <strong class="text-green-600">"צ'ק-אין למקום"</strong>.</li>
                            <li>הטיימר יתחיל לרוץ ותוכלו לראות את המרחק שלכם מהיעד בזמן אמת.</li>
                        </ul>
                        <button onclick="nextSlide(3)" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition">הבא</button>
                    </div>
                    <!-- Slide 3 -->
                    <div id="slide-3" class="slide hidden">
                        <h2 class="text-2xl font-bold mb-4">איך זה עובד: צעד 3</h2>
                        <ul class="list-disc list-inside text-gray-700 space-y-2 mb-6">
                            <li><strong class="text-blue-600">הגעה:</strong> כשתגיעו לרדיוס של 10 מטר מהיעד, האפליקציה תשאל אתכם אם הגעתם.</li>
                            <li>זמן ההמתנה שלכם יישמר ויעזור לדייק את הממוצע עבור שאר המשתמשים.</li>
                        </ul>
                        <button onclick="finishOnboarding()" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition">הבנתי, בואו נתחיל!</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Screen -->
    <div id="main-screen" class="flex flex-col flex-1 min-h-0">
        <!-- Header -->
        <header class="bg-white shadow-md p-4 z-30">
            <h1 class="text-2xl font-bold text-center text-blue-600">!תפוס מקום</h1>
        </header>
        
        <!-- Tab Navigation -->
        <nav class="bg-white shadow-sm z-20">
            <div class="flex justify-around max-w-lg mx-auto">
                <button id="tab-btn-map" class="tab-btn active w-full py-3 font-semibold text-gray-600" onclick="switchTab('map')">מפה</button>
                <button id="tab-btn-locations" class="tab-btn w-full py-3 font-semibold text-gray-600" onclick="switchTab('locations')">המקומות שלי</button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 relative overflow-hidden min-h-0">
            
            <!-- Map Tab -->
            <div id="tab-content-map" class="tab-content active h-full w-full">
                <!-- Map Container -->
                <div id="map" class="h-full w-full" style="z-index: 10;"></div>
                
                <!-- Search Bar -->
                <div class="absolute top-4 left-4 right-4 z-20 bg-white p-2 rounded-lg shadow-lg flex gap-2">
                    <input type="text" id="location-name-input" class="flex-1 w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="חפש שם מקום...">
                    <button id="search-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <!-- NEW: GPS Status Button -->
                <div class="absolute left-4 z-20 bottom-safe">
                    <button id="gps-status-btn" class="bg-white p-3 rounded-lg shadow-lg text-sm text-gray-600 font-medium text-right transition-all hover:bg-gray-50 active:scale-95 disabled:opacity-80 disabled:active:scale-100 disabled:hover:bg-white cursor-default disabled:cursor-not-allowed">
                        מאתר מיקום GPS...
                    </button>
                </div>

                <!-- Target Details Card (Hidden by default) -->
                <div id="target-details-card" class="absolute right-4 left-4 z-20 p-4 bg-white rounded-xl shadow-2xl transition-all duration-300 translate-y-full max-h-[70vh] overflow-y-auto bottom-safe">
                    <!-- Card content is set dynamically by JS -->
                </div>
            </div>

            <!-- My Locations Tab -->
            <div id="tab-content-locations" class="tab-content h-full w-full overflow-y-auto bg-gray-50 p-4">
                <h2 class="text-xl font-bold text-gray-800 mb-4">כל המקומות השמורים</h2>
                <div id="all-locations-list" class="space-y-3">
                    <!-- Location items will be injected here -->
                    <p class="text-gray-500 text-center">עדיין לא שמרתם מקומות...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Check-in "Waiting" Screen -->
    <div id="waiting-screen" class="fixed inset-0 bg-gradient-to-br from-gray-900 to-gray-800 text-white z-40 p-6 flex flex-col min-h-full w-full overflow-y-auto hidden" style="padding-top: calc(1.5rem + var(--safe-area-top)); padding-bottom: calc(1.5rem + var(--safe-area-bottom));">
        
        <!-- Header -->
        <div class="flex-shrink-0">
            <h2 class="text-2xl sm:text-3xl font-bold text-center mb-1">תור התחיל!</h2>
            <p id="waiting-location-name" class="text-lg text-blue-300 text-center mb-6">טוען...</p>
        </div>

        <!-- Timer Animation -->
        <div class="flex-grow flex flex-col items-center justify-center space-y-6">
            <div class="relative flex items-center justify-center w-56 h-56 sm:w-64 sm:h-64">
                <div class="absolute inset-0 bg-white bg-opacity-10 rounded-full timer-pulse"></div>
                <div class="absolute inset-4 bg-white bg-opacity-10 rounded-full timer-pulse" style="animation-delay: 0.5s;"></div>
                <div id="timer-display" class="relative text-5xl sm:text-6xl font-bold" style="font-variant-numeric: tabular-nums;">
                    00:00
                </div>
            </div>

            <!-- Status & Intel -->
            <div class="w-full max-w-md space-y-4">
                <!-- Status Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white bg-opacity-10 p-4 rounded-lg text-center">
                        <div class="text-sm uppercase text-blue-200 mb-1">מרחק ליעד</div>
                        <div id="waiting-distance" class="text-2xl font-semibold">...מאתר</div>
                        <div id="gps-countdown-el" class="text-xs text-gray-400 h-4"></div>
                    </div>
                    <div class="bg-white bg-opacity-10 p-4 rounded-lg text-center">
                        <div class="text-sm uppercase text-blue-200 mb-1">כיוון</div>
                        <div id="waiting-bearing" class="text-2xl font-semibold">...מאתר</div>
                    </div>
                </div>
                
                <!-- Mini Map -->
                <div class="bg-white bg-opacity-10 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3 text-center text-blue-200">מפה חיה</h3>
                    <div id="mini-map" class="w-full h-48 rounded-md border border-gray-600 overflow-hidden bg-gray-700"></div>
                </div>
                
                <!-- Gemini: Intel -->
                <div class="bg-white bg-opacity-10 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3 text-center text-blue-200">פרטי יעד</h3>
                    <div id="info-loading" class="flex items-center justify-center text-gray-300">
                        <div class="spinner w-5 h-5 border-2 rounded-full mr-2"></div>
                        טוען מידע...
                    </div>
                    <p id="info-error" class="text-red-400 text-center"></p>
                    <p id="info-result" class="text-gray-200 whitespace-pre-wrap text-sm leading-relaxed"></p>
                    <div id="info-sources" class="mt-3 text-sm text-gray-400"></div>
                </div>
            </div>
        </div>

        <!-- Footer Buttons -->
        <div class="flex-shrink-0 w-full max-w-md mx-auto space-y-3 pt-4 safe-bottom-space">
            <button id="manual-finish-btn" class="w-full bg-yellow-500 text-black font-bold py-3 px-4 rounded-md hover:bg-yellow-400 transition">
                סיום ידני ושמירה
            </button>
            <button id="cancel-check-in-btn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-md hover:bg-red-700 transition">
                ביטול התור
            </button>
        </div>
    </div>

    <!-- Success Message -->
    <div id="success-message" class="fixed inset-0 bg-black bg-opacity-75 flex items-start sm:items-center justify-center z-50 p-4 overflow-y-auto hidden" style="padding-top: calc(1rem + var(--safe-area-top)); padding-bottom: calc(1rem + var(--safe-area-bottom));">
        <div class="bg-white rounded-lg shadow-2xl p-6 text-center max-w-sm mx-auto float-in safe-bottom-pad">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h2 class="text-2xl font-bold mb-2">הגעת!</h2>
            <p id="success-time" class="text-gray-700 text-lg mb-4">זמן ההמתנה שלך (00:00) נשמר!</p>
            <button id="close-success-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition">סגור</button>
        </div>
    </div>

    <!-- Arrival Confirmation Modal -->
    <div id="arrival-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-start sm:items-center justify-center z-50 p-4 overflow-y-auto hidden" style="padding-top: calc(1rem + var(--safe-area-top)); padding-bottom: calc(1rem + var(--safe-area-bottom));">
        <div class="bg-white rounded-lg shadow-2xl p-6 text-center max-w-sm mx-auto float-in safe-bottom-pad">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </div>
            <h2 class="text-2xl font-bold mb-2">נראה שהגעת!</h2>
            <p class="text-gray-700 text-lg mb-6">האם הגעת ליעד וברצונך לסיים את התור?</p>
            <div class="space-y-3">
                <button id="confirm-arrival-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-md hover:bg-green-700 transition">כן, סיימתי!</button>
                <button id="deny-arrival-btn" class="w-full bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-md hover:bg-gray-400 transition">לא, להמשיך לחכות</button>
            </div>
        </div>
    </div>


    <script type="module">
    // Immediately Invoked Function Expression (IIFE) to encapsulate the app
    (function () {
        // --- App State ---
        let map;
        let userMarker;
        let targetMarker, targetCircle, targetCoords;
        let targetName = "";
        let currentLocationId = null;
        let gpsWatcherId = null;
        let checkInStartTime = null; // Timestamp
        let checkInTimerInterval = null;
        let gpsCountdownInterval = null;
        let userIcon;
        let miniMap, miniMapTargetMarker, miniMapUserMarker;
        let lastGpsTime = null;
        let lastKnownPosition = null;
        let confirmationCooldownUntil = null; // Cooldown for arrival confirmation
        let visitedLocationsLayer;

        // --- IMPORTANT API KEY ---
        // The Gemini API features will not work without a valid API key.
        // Get one from Google AI Studio and paste it here.
        const GEMINI_API_KEY = "AIzaSyC_DLS4a-6tU26oME_NqYQfIFfSg8rg1fo"; // <--- PASTE YOUR API KEY HERE

        // --- Local Storage DB Key ---
        const LOCAL_DB_KEY = 'tfosMakomDB';

        // --- Element Refs ---
        const mainScreen = document.getElementById('main-screen');
        const waitingScreen = document.getElementById('waiting-screen');
        const onboardingModal = document.getElementById('onboarding-modal');
        const targetDetailsCard = document.getElementById('target-details-card');
        
        // Map Tab
        const searchBtn = document.getElementById('search-btn');
        const locationNameInput = document.getElementById('location-name-input');
        // const gpsErrorEl = document.getElementById('gps-error-el'); // OLD
        const gpsStatusBtn = document.getElementById('gps-status-btn'); // NEW
        
        // Locations Tab
        const allLocationsList = document.getElementById('all-locations-list');

        // Waiting Screen
        const waitingLocationName = document.getElementById('waiting-location-name');
        const timerDisplay = document.getElementById('timer-display');
        const waitingDistance = document.getElementById('waiting-distance');
        const waitingBearing = document.getElementById('waiting-bearing');
        const gpsCountdownEl = document.getElementById('gps-countdown-el');
        const infoLoading = document.getElementById('info-loading');
        const infoResult = document.getElementById('info-result');
        const infoSources = document.getElementById('info-sources');
        const infoErrorEl = document.getElementById('info-error');
        const cancelCheckInBtn = document.getElementById('cancel-check-in-btn');
        const manualFinishBtn = document.getElementById('manual-finish-btn');
        
        // Success Modal
        const successMessage = document.getElementById('success-message');
        const successTime = document.getElementById('success-time');
        const closeSuccessBtn = document.getElementById('close-success-btn');

        // Arrival Confirmation Modal Refs
        const arrivalConfirmationModal = document.getElementById('arrival-confirmation-modal');
        const confirmArrivalBtn = document.getElementById('confirm-arrival-btn');
        const denyArrivalBtn = document.getElementById('deny-arrival-btn');

        // --- 0. Initialize App ---
        function initApp() {
            initMap();
            
            // Define user icon
            userIcon = L.divIcon({
                className: 'user-location-icon',
                iconSize: [18, 18]
            });
            
            // Event Listeners
            searchBtn.addEventListener('click', handleSearchLocation);
            locationNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSearchLocation();
            });
            
            cancelCheckInBtn.addEventListener('click', () => finishCheckIn(false)); // Don't save
            manualFinishBtn.addEventListener('click', () => finishCheckIn(true)); // Save
            closeSuccessBtn.addEventListener('click', () => successMessage.classList.add('hidden'));

            // Arrival Confirmation Listeners
            confirmArrivalBtn.addEventListener('click', handleConfirmArrival);
            denyArrivalBtn.addEventListener('click', handleDenyArrival);

            // NEW: GPS Button Listener
            gpsStatusBtn.addEventListener('click', startGpsWatcher);

            // Check for onboarding
            if (localStorage.getItem('tfosMakomOnboarding') === 'true') {
                onboardingModal.classList.add('hidden');
            } else {
                onboardingModal.classList.remove('hidden');
            }
            
            // Load saved locations into tab
            renderAllLocations();
            
            // Start GPS Watcher on load
            startGpsWatcher();
        }

        // --- 1. Onboarding Logic ---
        window.nextSlide = function(slideNumber) {
            document.querySelectorAll('.slide').forEach(s => s.classList.add('hidden'));
            document.getElementById(`slide-${slideNumber}`).classList.remove('hidden');
            
            const progress = (slideNumber / 3) * 100;
            document.getElementById('onboarding-progress').style.width = `${progress}%`;
        }

        window.finishOnboarding = function() {
            localStorage.setItem('tfosMakomOnboarding', 'true');
            onboardingModal.classList.add('hidden');
        }

        // --- 2. Tab Navigation ---
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-content-${tabName}`).classList.add('active');
            document.getElementById(`tab-btn-${tabName}`).classList.add('active');

            if (tabName === 'locations') {
                renderAllLocations();
            } else if (tabName === 'map') {
                renderVisitedLocationsOnMap();
                // Invalidate map size to fix potential rendering issues
                setTimeout(() => map.invalidateSize(), 0);
            }
        }
        
        // --- 3. Map & Search ---
        function initMap() {
            map = L.map('map', {
                zoomControl: false // Disable default zoom
            }).setView([32.0853, 34.7818], 13); // Default to Tel Aviv

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            visitedLocationsLayer = L.layerGroup().addTo(map);

            // Add zoom control to bottom-right
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Set target on map click
            map.on('click', (e) => {
                const { lat, lng } = e.latlng;
                targetName = `מיקום (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
                locationNameInput.value = targetName;
                selectLocation(lat, lng, targetName);
            });

            renderVisitedLocationsOnMap();
        }

        async function handleSearchLocation() {
            const query = locationNameInput.value;
            if (!query) return;

            searchBtn.disabled = true;
            searchBtn.innerHTML = '<div class="spinner w-5 h-5 border-2 rounded-full"></div>';
            
            try {
                // Use Nominatim for free geocoding
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const { lat, lon, display_name } = data[0];
                    targetName = display_name;
                    locationNameInput.value = targetName;
                    selectLocation(parseFloat(lat), parseFloat(lon), targetName);
                } else {
                    alert('לא נמצאו תוצאות עבור החיפוש.');
                }
            } catch (error) {
                console.error('Error searching location:', error);
                alert('אירעה שגיאה בחיפוש המיקום.');
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>`;
            }

            renderVisitedLocationsOnMap();
        }

        function selectLocation(lat, lon, name, id = null) {
            targetCoords = { lat, lon };
            targetName = name;
            
            // Generate a unique ID if one isn't provided
            currentLocationId = id || `loc_${lat.toFixed(6)}_${lon.toFixed(6)}`;

            // Clear previous markers
            if (targetMarker) map.removeLayer(targetMarker);
            if (targetCircle) map.removeLayer(targetCircle);

            // Add new marker (10m radius)
            targetMarker = L.marker([lat, lon]).addTo(map);
            targetCircle = L.circle([lat, lon], { radius: 10, color: 'blue', fillColor: '#30f', fillOpacity: 0.3, weight: 2 }).addTo(map);

            // Zoom map
            map.setView([lat, lon], 19);

            // Show location details card
            showLocationCard(name, currentLocationId);
            
            // Ensure map tab is active
            if (document.getElementById('tab-content-locations').classList.contains('active')) {
                switchTab('map');
            }
        }

        function showLocationCard(name, id) {
            const db = getDb();
            const locationData = db[id] || { totalCheckIns: 0, avgWaitSeconds: 0 };

            const avgTimeDisplay = locationData.totalCheckIns > 0
                ? `${formatDuration(locationData.avgWaitSeconds)} דקות`
                : "אין עדיין מידע";

            targetDetailsCard.innerHTML = `
                <h3 class="font-bold text-lg mb-2">${name}</h3>
                <div class="flex justify-between text-sm mb-4">
                    <div class="text-gray-600">
                        <span class="font-semibold">זמן המתנה ממוצע:</span>
                        <span>${avgTimeDisplay}</span>
                    </div>
                    <div class="text-gray-600">
                        <span class="font-semibold">צ'ק-אינים:</span>
                        <span>${locationData.totalCheckIns}</span>
                    </div>
                </div>
                <button id="start-check-in-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-md hover:bg-green-700 transition">
                    התחל צ'ק-אין למקום
                </button>
            `;
            
            // Add event listener to the new button
            document.getElementById('start-check-in-btn').onclick = startCheckIn;
            
            // Animate card in
            targetDetailsCard.classList.remove('translate-y-full');
            targetDetailsCard.classList.add('float-in');
        }

        // --- 4. Check-In Logic ---
        function startCheckIn() {
            if (!targetCoords) {
                alert("אנא בחר מיקום תחילה.");
                return;
            }
            
            // Hide main screen, show waiting screen
            mainScreen.classList.add('hidden');
            waitingScreen.classList.remove('hidden');
            
            waitingLocationName.textContent = targetName;
            
            // Reset UI
            timerDisplay.textContent = "00:00";
            // Clearer initial state
            waitingDistance.textContent = "...ממתין ל-GPS";
            waitingBearing.textContent = "...ממתין ל-GPS";
            gpsCountdownEl.textContent = "";
            infoResult.textContent = "";
            infoSources.textContent = "";
            infoErrorEl.textContent = "";
            infoLoading.classList.remove('hidden');

            // Start Timer
            checkInStartTime = Date.now();
            checkInTimerInterval = setInterval(updateTimerDisplay, 1000);
            
            // (GPS watcher is already running, it will now pick up the new state)
            
            // Immediately update UI with last known position
            if (lastKnownPosition) {
                updateWaitingUI(lastKnownPosition); 
            }

            // Fire Gemini Calls
            handleGetInfo();
            
            // Init Mini Map
            setTimeout(initMiniMap, 100); 
        }

        function updateTimerDisplay() {
            if (!checkInStartTime) return;
            
            const elapsedSeconds = (Date.now() - checkInStartTime) / 1000;
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = Math.floor(elapsedSeconds % 60);
            
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateWaitingUI(position) {
            if (!checkInStartTime || !targetCoords) return; // Only run if checking in

            const { latitude: userLat, longitude: userLon } = position.coords;
            const userLatLng = L.latLng(userLat, userLon);

            // Update user marker on MINI map
            if (miniMap) {
                if (!miniMapUserMarker) {
                    miniMapUserMarker = L.marker(userLatLng, { icon: userIcon }).addTo(miniMap);
                } else {
                    miniMapUserMarker.setLatLng(userLatLng);
                }
                
                // Keep both markers in view
                miniMap.fitBounds(L.latLngBounds(userLatLng, [targetCoords.lat, targetCoords.lon]), { padding: [20, 20], maxZoom: 17 });
            }

            // Calculations
            const distance = map.distance([userLat, userLon], [targetCoords.lat, targetCoords.lon]);
            const bearing = getBearing(userLat, userLon, targetCoords.lat, targetCoords.lon);
            const compassDirection = getCompassDirection(bearing);
            
            // Update Waiting UI
            waitingDistance.textContent = `${distance.toFixed(1)} מטר`;
            waitingBearing.textContent = `${bearing.toFixed(1)}° (${compassDirection})`;

            // --- The "Win" Condition ---
            if (distance <= 10) {
                // Check if we are in a cooldown period
                if (confirmationCooldownUntil && Date.now() < confirmationCooldownUntil) {
                    // Cooldown is active, do nothing
                    return;
                }
                
                // Check if modal is already open
                if (!arrivalConfirmationModal.classList.contains('hidden')) {
                    // Modal is already open, do nothing
                    return;
                }

                // --- Show Confirmation ---
                console.log("User entered 10m radius. Showing confirmation.");
                
                // Pause the timer
                if (checkInTimerInterval) {
                    clearInterval(checkInTimerInterval);
                    checkInTimerInterval = null;
                }
                
                // Show the modal
                arrivalConfirmationModal.classList.remove('hidden');
            }
        }
       
        function handleConfirmArrival() {
            arrivalConfirmationModal.classList.add('hidden');
            finishCheckIn(true); // Save data and finish
        }

        function handleDenyArrival() {
            arrivalConfirmationModal.classList.add('hidden');
            
            // Set 30 second cooldown to prevent modal from popping up immediately
            confirmationCooldownUntil = Date.now() + 30000; 
            
            // Resume timer
            if (checkInStartTime && !checkInTimerInterval) {
                checkInTimerInterval = setInterval(updateTimerDisplay, 1000);
            }
        }

        function finishCheckIn(saveData) {
            // Ensure confirmation modal is hidden and cooldown is reset
            arrivalConfirmationModal.classList.add('hidden');
            confirmationCooldownUntil = null;

            // Stop timers
            if (checkInTimerInterval) clearInterval(checkInTimerInterval);
            if (gpsCountdownInterval) clearInterval(gpsCountdownInterval);
            checkInTimerInterval = null;
            gpsCountdownInterval = null;
            
            destroyMiniMap(); // Destroy mini-map
            
            const finalTimeDisplay = timerDisplay.textContent;
            
            if (saveData && checkInStartTime) {
                const elapsedSeconds = (Date.now() - checkInStartTime) / 1000;
                saveWaitTime(currentLocationId, targetName, targetCoords, elapsedSeconds);
                
                // Show success message
                successTime.textContent = `זמן ההמתנה שלך (${finalTimeDisplay}) נשמר!`;
                successMessage.classList.remove('hidden');
            }
            
            // Reset state
            checkInStartTime = null;
            // currentLocationId and targetName are kept for the card
            
            // Hide waiting screen, show main screen
            waitingScreen.classList.add('hidden');
            mainScreen.classList.remove('hidden');
            
            // Re-show location card
            if (targetCoords) {
                showLocationCard(targetName, currentLocationId);
            }
        }

        // --- 5. GPS Watcher ---
        function startGpsWatcher() {
            // NEW: If a successful watcher is already running, don't start another.
            if (gpsWatcherId !== null && lastKnownPosition !== null) {
                console.log("GPS watcher is active and has a fix.");
                return;
            }

            // NEW: If a watcher is trying (has ID but no position), clear it before starting a new one.
            if (gpsWatcherId !== null) {
                navigator.geolocation.clearWatch(gpsWatcherId);
                gpsWatcherId = null;
            }

            if (!navigator.geolocation) {
                // gpsErrorEl.textContent = "GPS אינו נתמך בדפדפן זה."; // OLD
                gpsStatusBtn.textContent = "GPS אינו נתמך"; // NEW
                gpsStatusBtn.disabled = true; // NEW
                return;
            }

            // NEW: Set button state to loading
            gpsStatusBtn.textContent = "מאתר מיקום GPS...";
            gpsStatusBtn.disabled = true;

            const options = {
                enableHighAccuracy: true,
                timeout: 5000, // 5 seconds
                maximumAge: 0 // Don't use a cached position
            };

            gpsWatcherId = navigator.geolocation.watchPosition(
                updatePosition, 
                handleGpsError, 
                options
            );
        }

        function updatePosition(position) {
            lastGpsTime = Date.now();
            lastKnownPosition = position; // Store last known position
            startGpsCountdown(); // Start/reset the 5-second countdown
            
            console.log("GPS Update Received at:", new Date().toLocaleTimeString(), position.coords);
            const { latitude: userLat, longitude: userLon } = position.coords;
            
            // gpsErrorEl.textContent = "GPS פעיל"; // OLD
            gpsStatusBtn.textContent = "GPS פעיל"; // NEW
            gpsStatusBtn.disabled = true; // NEW: Disable on success

            // Update user marker on MAIN map
            const userLatLng = L.latLng(userLat, userLon);
            if (!userMarker) {
                userMarker = L.marker(userLatLng, { icon: userIcon }).addTo(map).bindPopup("<b>מיקומך</b>");
                map.setView(userLatLng, 17); // Pan to user on first fix
            } else {
                userMarker.setLatLng(userLatLng);
            }
            
            // --- Logic for when check-in is ACTIVE ---
            if (checkInStartTime && targetCoords) {
                updateWaitingUI(position); // Call the new UI update function
            }
        }

        function handleGpsError(error) {
            console.warn(`GPS Error: ${error.message}`);
            let message = "שגיאת GPS";
            if (error.code === error.PERMISSION_DENIED) {
                message = "לחץ כאן לאישור מיקום"; // NEW
            } else if (error.code === error.POSITION_UNAVAILABLE) {
                message = "מיקום לא זמין. לחץ לנסות שוב."; // NEW
            } else if (error.code === error.TIMEOUT) {
                message = "זמן קצוב. לחץ לנסות שוב."; // NEW
            }
            // gpsErrorEl.textContent = message; // OLD
            gpsStatusBtn.textContent = message; // NEW
            gpsStatusBtn.disabled = false; // NEW: Re-enable button on failure
            
            // NEW: Clear the failed watcher ID so it can be started again
            if (gpsWatcherId) {
                navigator.geolocation.clearWatch(gpsWatcherId);
                gpsWatcherId = null;
            }

            if (checkInStartTime) {
                waitingDistance.textContent = "שגיאת GPS";
                waitingBearing.textContent = "שגיאת GPS";
            }
        }
        
        function startGpsCountdown() {
            if (gpsCountdownInterval) clearInterval(gpsCountdownInterval);
            if (!checkInStartTime) {
                gpsCountdownEl.textContent = "";
                return;
            }
            
            let secondsLeft = 5; // 5 second timeout
            
            const updateCountdown = () => {
                if (!checkInStartTime) { // Check if check-in was cancelled
                     clearInterval(gpsCountdownInterval);
                     gpsCountdownEl.textContent = "";
                     return;
                }
                
                const sinceLastUpdate = (Date.now() - lastGpsTime) / 1000;
                secondsLeft = Math.max(0, 5 - sinceLastUpdate);
                
                gpsCountdownEl.textContent = `(עדכון בעוד ${secondsLeft.toFixed(0)} ש')`;
                
                if (secondsLeft <= 0) {
                    clearInterval(gpsCountdownInterval);
                    gpsCountdownEl.textContent = "(ממתין לעדכון...)";
                }
            };
            
            updateCountdown(); // Run immediately
            gpsCountdownInterval = setInterval(updateCountdown, 500);
        }

        // --- 6. Bearing & Compass Calculations ---
        function getBearing(lat1, lon1, lat2, lon2) {
            const rad = Math.PI / 180;
            const dLon = (lon2 - lon1) * rad;
            lat1 = lat1 * rad;
            lat2 = lat2 * rad;
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            let brng = Math.atan2(y, x) * (180 / Math.PI);
            brng = (brng + 360) % 360;
            return brng;
        }

        function getCompassDirection(bearing) {
            const directions = ['צפון', 'צפון-מזרח', 'מזרח', 'דרום-מזרח', 'דרום', 'דרום-מערב', 'מערב', 'צפון-מערב'];
            const index = Math.round(bearing / 45) % 8;
            return directions[index];
        }

        // --- 7. Local Storage DB ---
        function getDb() {
            try {
                const db = localStorage.getItem(LOCAL_DB_KEY);
                return db ? JSON.parse(db) : {};
            } catch (e) {
                console.error("Failed to parse local DB", e);
                return {};
            }
        }

        function saveDb(db) {
            localStorage.setItem(LOCAL_DB_KEY, JSON.stringify(db));
        }

        function saveWaitTime(id, name, coords, waitSeconds) {
            const db = getDb();
            const locationData = db[id] || {
                name: name,
                coords: coords,
                totalCheckIns: 0,
                totalWaitSeconds: 0,
                avgWaitSeconds: 0,
                visits: []
            };

            locationData.totalCheckIns += 1;
            locationData.totalWaitSeconds += waitSeconds;
            locationData.avgWaitSeconds = locationData.totalWaitSeconds / locationData.totalCheckIns;

            if (!Array.isArray(locationData.visits)) {
                locationData.visits = [];
            }

            locationData.visits.unshift({
                timestamp: new Date().toISOString(),
                waitSeconds: waitSeconds
            });

            // Keep only the most recent 20 visits to avoid unlimited growth
            locationData.visits = locationData.visits.slice(0, 20);

            db[id] = locationData;
            saveDb(db);

            renderVisitedLocationsOnMap();

            // Re-render location list if tab is open
            if (document.getElementById('tab-content-locations').classList.contains('active')) {
                renderAllLocations();
            }
        }
        
        // --- 8. Render All Locations Tab ---
        function renderAllLocations() {
            const db = getDb();
            const locations = Object.entries(db);

            if (locations.length === 0) {
                allLocationsList.innerHTML = `<p class="text-gray-500 text-center">עדיין לא שמרתם מקומות...</p>`;
                return;
            }
            
            allLocationsList.innerHTML = ''; // Clear list
            
            // Sort by most check-ins
            locations.sort(([, a], [, b]) => b.totalCheckIns - a.totalCheckIns);
            
            for (const [id, data] of locations) {
                const avgTimeDisplay = data.totalCheckIns > 0
                    ? `${formatDuration(data.avgWaitSeconds)} דקות`
                    : "אין עדיין מידע";

                const el = document.createElement('div');
                el.className = "bg-white p-4 rounded-lg shadow-md border";
                el.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-lg text-gray-800">${data.name}</h3>
                            <p class="text-sm text-gray-600">זמן המתנה ממוצע: <span class="font-medium text-blue-600">${avgTimeDisplay}</span></p>
                            <p class="text-sm text-gray-600">סה"כ צ'ק-אינים: <span class="font-medium text-blue-600">${data.totalCheckIns}</span></p>
                        </div>
                        <button class="goto-location-btn text-sm bg-blue-100 text-blue-700 font-semibold py-2 px-3 rounded-md hover:bg-blue-200 transition">
                            עבור למיקום
                        </button>
                    </div>
                `;
                
                el.querySelector('.goto-location-btn').addEventListener('click', () => {
                    selectLocation(data.coords.lat, data.coords.lon, data.name, id);
                });
                
                allLocationsList.appendChild(el);
            }
        }

        function renderVisitedLocationsOnMap() {
            if (!map) return;

            if (!visitedLocationsLayer) {
                visitedLocationsLayer = L.layerGroup().addTo(map);
            }

            visitedLocationsLayer.clearLayers();

            const db = getDb();

            for (const [, data] of Object.entries(db)) {
                if (!data || !data.coords || !data.totalCheckIns) continue;

                const rawLat = data.coords.lat ?? data.coords.latitude;
                const rawLon = data.coords.lon ?? data.coords.lng ?? data.coords.longitude;

                const lat = typeof rawLat === 'number' ? rawLat : parseFloat(rawLat);
                const lon = typeof rawLon === 'number' ? rawLon : parseFloat(rawLon);

                if (Number.isNaN(lat) || Number.isNaN(lon)) continue;

                const marker = L.marker([lat, lon]).addTo(visitedLocationsLayer);
                L.circle([lat, lon], {
                    radius: 10,
                    color: '#2563eb',
                    weight: 1.5,
                    fillColor: '#60a5fa',
                    fillOpacity: 0.2
                }).addTo(visitedLocationsLayer);

                const visitList = Array.isArray(data.visits) ? data.visits : [];
                const recentVisits = visitList.slice(0, 3);

                let popupContent = `
                    <div dir="rtl" style="text-align: right;">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${data.name}</div>
                        <div style="font-size: 0.875rem;">צ'ק-אינים: <strong>${data.totalCheckIns}</strong></div>
                        <div style="font-size: 0.875rem;">זמן המתנה ממוצע: <strong>${formatDuration(data.avgWaitSeconds)} דקות</strong></div>
                `;

                if (recentVisits.length > 0) {
                    const visitsHtml = recentVisits
                        .map((visit) => {
                            const waitTime = formatDuration(visit.waitSeconds);
                            const when = formatTimestamp(visit.timestamp);
                            return `<li style="margin: 0.25rem 0;">${when} · ${waitTime} דקות</li>`;
                        })
                        .join('');

                    popupContent += `
                        <div style="margin-top: 0.5rem; font-size: 0.8125rem;">
                            <div style="font-weight: 600;">ביקורים אחרונים:</div>
                            <ul style="padding-right: 1rem; margin: 0; list-style: disc;">${visitsHtml}</ul>
                        </div>
                    `;
                }

                popupContent += '</div>';

                marker.bindPopup(popupContent);
            }
        }

        function formatDuration(seconds) {
            const numericSeconds = Number(seconds);
            if (!Number.isFinite(numericSeconds) || numericSeconds < 0) return '00:00';

            const totalSeconds = Math.round(numericSeconds);
            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const secs = Math.abs(totalSeconds % 60).toString().padStart(2, '0');
            return `${minutes}:${secs}`;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'לא ידוע';

            const date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) return 'לא ידוע';

            return date.toLocaleString('he-IL', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // --- 9. Gemini API ---
        async function callGeminiApi(payload) {
            const apiKey = GEMINI_API_KEY; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            let response;
            try {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Error Response:", errorBody);
                    throw new Error(`API request failed with status ${response.status}: ${errorBody.error?.message || 'Unknown error'}`);
                }
                
                return await response.json();
                
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                throw error;
            }
        }

        async function handleGetInfo() {
            if (!targetCoords) return;

            infoLoading.classList.remove('hidden');
            infoResult.textContent = "";
            infoSources.textContent = "";
            infoErrorEl.textContent = "";

            // --- API Key Check ---
            if (!GEMINI_API_KEY) {
                displayApiError("פיצ'ר זה דורש מפתח API של Gemini. יש להוסיף אותו בקוד.", infoErrorEl);
                infoLoading.classList.add('hidden');
                return;
            }
            // --- End Check ---

            const userQuery = `What is at latitude ${targetCoords.lat} and longitude ${targetCoords.lon}? If it's a place, tell me about it. If it's not a known place, describe the area. Keep it to one short paragraph. (Context: Target name is "${targetName}")`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "You are an intelligence operative providing a concise briefing. Be informative and direct." }]
                },
            };

            try {
                const result = await callGeminiApi(payload);
                console.log("Gemini API Result:", result); // Added for debugging
                const candidate = result.candidates?.[0];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    infoResult.textContent = candidate.content.parts[0].text;
                    
                    // Display sources
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        const sources = groundingMetadata.groundingAttributions
                            .map(attr => attr.web?.title && attr.web?.uri ? { title: attr.web.title, uri: attr.web.uri } : null)
                            .filter(Boolean); // Remove nulls
                        
                        if (sources.length > 0) {
                            infoSources.innerHTML = '<strong>מקורות:</strong> ' + sources
                                .map(s => `<a href="${s.uri}" target="_blank" class="text-blue-300 hover:underline">${s.title}</a>`)
                                .join(', ');
                        }
                    }
                } else {
                    displayApiError("לא התקבל תוכן תקין מה-API.", infoErrorEl);
                }
            } catch (error) {
                console.error("Failed to get info:", error);
                displayApiError(`שגיאה בטעינת מידע: ${error.message}`, infoErrorEl);
            } finally {
                infoLoading.classList.add('hidden');
            }
        }
        
        function displayApiError(message, element) {
            element.textContent = message;
        }
 
        // --- 10. Mini Map Functions ---
        function initMiniMap() {
            if (miniMap) {
                miniMap.remove();
                miniMap = null;
            }
            if (!targetCoords) return;

            try {
                const miniMapEl = document.getElementById('mini-map');
                if (!miniMapEl) return;
                
                miniMapEl.innerHTML = ''; // Clear any error messages
                
                miniMap = L.map('mini-map', { 
                    zoomControl: false, 
                    scrollWheelZoom: false,
                    dragging: false,
                    touchZoom: false,
                    doubleClickZoom: false
                }).setView([targetCoords.lat, targetCoords.lon], 17);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);
                miniMapTargetMarker = L.marker([targetCoords.lat, targetCoords.lon]).addTo(miniMap);
                
                // If user location is already known, add it
                if (lastKnownPosition) {
                    const userLatLng = L.latLng(lastKnownPosition.coords.latitude, lastKnownPosition.coords.longitude);
                    miniMapUserMarker = L.marker(userLatLng, { icon: userIcon }).addTo(miniMap);
                    miniMap.fitBounds(L.latLngBounds(userLatLng, [targetCoords.lat, targetCoords.lon]), { padding: [20, 20], maxZoom: 17 });
                }
                
                // Fix for grey map bug
                miniMap.invalidateSize(); 

            } catch (e) {
                console.error("Error initializing mini-map:", e);
                const miniMapEl = document.getElementById('mini-map');
                if (miniMapEl) {
                    miniMapEl.innerHTML = '<p class="text-red-500 p-2 text-center">שגיאה בטעינת המפה.</p>';
                }
            }
        }

        function destroyMiniMap() {
            if (miniMap) {
                miniMap.remove();
                miniMap = null;
            }
            miniMapTargetMarker = null;
            miniMapUserMarker = null;
        }

        // --- Run Initialization ---
        initApp();
        
    })(); // End of IIFE
    </script>
 
</body>
</html>


